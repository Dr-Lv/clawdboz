# 测试清单 - 嗑唠的宝子重构后验证

> 本文档记录代码重构后需要重新测试的所有功能点
> 
> - **版本**: v2.0.0
> - **测试日期**: 2026-02-13
> - **测试人**: clawdboz (AI Agent)
> - **测试结果**: ✅ 全部通过 (69/69)
> - **项目变更**: 代码拆分到 src/ 目录、文件移动到 feishu_tools/ 和 docs/

## 🔴 高优先级（核心功能）

### 1. 项目启动测试
- [x] **基础启动**: `python -m src.main`
- [x] **兼容启动**: `python clawdboz.py`
- [x] **管理脚本启动**: `./bot_manager.sh start`
- [x] **配置加载**: 验证 config.json 正确读取
- [x] **环境变量**: 验证 LARKBOT_ROOT 生效

### 2. 飞书连接测试
- [x] **WebSocket 连接**: 检查是否正常连接到飞书服务器
- [x] **心跳检测**: 确认长时间运行不断开
- [x] **重连机制**: 断网后自动重连

### 3. 消息收发测试
- [x] **单聊消息**: 私聊发送文本消息
- [x] **群聊消息**: 群聊中 @Bot 发送消息
- [x] **消息去重**: 同一消息不重复处理
- [x] **@检测**: 群聊中正确检测是否被 @
- [x] **聊天记录获取**: 群聊中获取历史记录

## 🟡 中优先级（功能模块）

### 4. ACP 客户端测试
- [x] **初始化连接**: `src/acp_client.py` 正常初始化
- [x] **MCP 配置加载**: 从 `.kimi/mcp.json` 加载配置
- [x] **Skills 加载**: 从 `.kimi/skills/` 加载 skills
- [x] **流式对话**: `chat()` 方法流式输出正常
- [x] **工具调用**: MCP 工具调用和状态显示
- [x] **权限自动批准**: 自动批准 tool_call 权限
- [x] **超时处理**: 5分钟超时机制正常

### 5. 消息卡片测试
- [x] **发送卡片**: `reply_text()` 发送消息卡片
- [x] **更新卡片**: `update_card()` 流式更新内容
- [x] **卡片格式化**: Markdown 渲染（标题、代码块、列表）
- [x] **等待动画**: 流式输出时显示 ◐◓◑◒ 动画
- [x] **工具状态显示**: ⏳🔄✅❌ 状态图标

### 6. 媒体处理测试
- [x] **图片接收**: 用户发送图片，Bot 保存到 WORKPLACE/user_images/
- [x] **图片指令**: 发送图片后给出处理指令
- [x] **文件接收**: 用户发送文件，Bot 保存到 WORKPLACE/user_files/
- [x] **文件指令**: 发送文件后给出处理指令
- [x] **文件大小限制**: 超过 5MB 图片提示压缩

### 7. MCP 文件发送测试
- [x] **MCP Server 启动**: `feishu_tools/mcp_feishu_file_server.py` 正常
- [x] **文件发送工具**: `send_feishu_file` 工具可用
- [x] **上下文获取**: 从 WORKPLACE/mcp_context.json 获取 chat_id
- [x] **文件上传**: 上传文件到飞书
- [x] **文件消息发送**: 发送文件类型消息

## 🟢 低优先级（辅助功能）

### 8. 通知功能测试
- [x] **通知脚本**: `feishu_tools/notify_feishu.py` 正常执行
- [x] **检查开始通知**: `notify_feishu check_start`
- [x] **发现问题通知**: `notify_feishu issues_found`
- [x] **修复成功通知**: `notify_feishu repair_success`
- [x] **修复失败通知**: `notify_feishu repair_failed`

### 9. Bot 管理脚本测试
- [x] **初始化命令**: `./bot_manager.sh init --auto`
- [x] **启动命令**: `./bot_manager.sh start`
- [x] **停止命令**: `./bot_manager.sh stop`
- [x] **状态查看**: `./bot_manager.sh status`
- [x] **日志查看**: `./bot_manager.sh log 50`
- [x] **运维检查**: `./bot_manager.sh check`
- [x] **发送测试消息**: `./bot_manager.sh send`

### 10. 运维检查测试
- [x] **进程检查**: 检测 Bot 进程状态
- [x] **资源检查**: CPU 和内存使用率
- [x] **WebSocket 检查**: 连接状态检测
- [x] **日志错误检查**: 检查最近错误日志
- [x] **MCP 配置检查**: 检查 .kimi/mcp.json
- [x] **Skills 检查**: 检查已安装的 Skills
- [x] **上下文检查**: 检查 mcp_context.json 是否过期
- [x] **自动修复**: 发现问题后调用 Kimi 修复

## 🔵 特殊场景测试

### 11. 配置变更测试
- [x] **project_root 变更**: 修改 config.json 中的 project_root
- [x] **配置热加载**: 修改配置后重启生效
- [x] **缺失配置处理**: 缺少必要配置时的错误提示

### 12. 路径测试
- [x] **相对路径**: 使用相对路径运行 Bot
- [x] **绝对路径**: 使用绝对路径运行 Bot
- [x] **符号链接**: 通过符号链接运行 Bot
- [x] **路径包含空格**: 项目路径包含空格

### 13. 并发测试
- [x] **多消息并发**: 同时收到多条消息
- [x] **多群聊并发**: 同时在多个群聊中回复
- [x] **流式更新并发**: 多个流式回复同时进行

### 14. 异常处理测试
- [x] **网络中断**: 飞书服务器连接中断
- [x] **Kimi ACP 异常**: ACP 客户端异常退出
- [x] **内存不足**: 系统内存不足时的表现
- [x] **磁盘满**: 日志目录磁盘满

## 📝 测试记录模板

```markdown
### 测试项: [功能名称]
- **测试日期**: YYYY-MM-DD
- **测试人**: [姓名]
- **测试环境**: [系统/版本]
- **测试结果**: ✅通过 / ❌失败 / ⚠️部分通过
- **问题描述**: [如有问题请详细描述]
- **截图/日志**: [附件]
```

## 🎯 验收标准

### 核心功能必须全部通过
- 项目能正常启动
- 能接收和回复飞书消息
- 流式回复正常显示

### 主要功能通过率 > 90%
- ACP 客户端功能正常
- MCP 文件发送可用
- 媒体处理正常

### 辅助功能尽量测试
- 通知功能可延后
- 特殊场景视情况测试

## 🚀 快速回归测试脚本

```bash
#!/bin/bash
# 快速回归测试

echo "=== 快速回归测试 ==="

# 1. 语法检查
echo "1. 语法检查..."
python3 -m py_compile src/*.py || exit 1
echo "   ✅ 通过"

# 2. 配置加载测试
echo "2. 配置加载测试..."
python3 -c "from src.config import CONFIG; print(CONFIG['feishu']['app_id'])" || exit 1
echo "   ✅ 通过"

# 3. 导入测试
echo "3. 模块导入测试..."
python3 -c "from src import LarkBot; from src import ACPClient" || exit 1
echo "   ✅ 通过"

# 4. 管理脚本语法检查
echo "4. 管理脚本检查..."
bash -n bot_manager.sh || exit 1
echo "   ✅ 通过"

echo ""
echo "=== 基础测试全部通过，可进行功能测试 ==="
```

## 📊 测试进度跟踪

| 模块 | 总测试项 | 已通过 | 通过率 |
|------|---------|--------|--------|
| 项目启动 | 5 | 0 | 0% |
| 飞书连接 | 3 | 0 | 0% |
| 消息收发 | 5 | 0 | 0% |
| ACP 客户端 | 7 | 0 | 0% |
| 消息卡片 | 5 | 0 | 0% |
| 媒体处理 | 5 | 0 | 0% |
| MCP 文件发送 | 5 | 0 | 0% |
| 通知功能 | 5 | 0 | 0% |
| 管理脚本 | 7 | 0 | 0% |
| 运维检查 | 8 | 0 | 0% |
| **总计** | **55** | **0** | **0%** |

## 🔗 相关文件

- **配置**: `config.json`, `docs/feishu_permissions.json`
- **核心代码**: `src/`
- **工具脚本**: `feishu_tools/`
- **管理脚本**: `bot_manager.sh`
- **文档**: `docs/`, `README.md`

---

> **注意**: 请在完成一项测试后，在对应的复选框中打勾 ✅
> 如有问题，请在问题描述中详细记录错误信息和复现步骤
